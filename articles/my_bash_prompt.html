<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>
    prompt.sh
     | My bash prompt
  </title>
  <script src="/javascripts/modernizr.min.js" type="text/javascript"></script>
  <link href="/stylesheets/fonts/serif/cmun-serif.css" rel="stylesheet" type="text/css" />
  <link href="/stylesheets/fonts/typewriter/cmun-typewriter.css" rel="stylesheet" type="text/css" />
  <link href="/stylesheets/all.css" rel="stylesheet" type="text/css" />
</head>
<body>
  <div id="layout" class="pure-skin-prompt pure-g-r">
    <div class="sidebar pure-u-1-4">
      <div class="header">
        <hgroup>
          <h1 class="brand-title">
            <a href="/">prompt</a>
          </h1>
          <h2 class="brand-tagline">Yesterday's computing tomorrow</h2>
        </hgroup>
      </div>
      <!-- <nav class="main-nav pure-menu pure-menu-open"> -->
      <!--   <ul> -->
      <!--     <li><a href="/">Home</a></li> -->
      <!--     <li><a href="#">About prompt</a></li> -->
      <!--     <li><a href="#">All posts</a></li> -->
      <!--   </ul> -->
      <!-- </nav> -->
    </div>

    <div class="content pure-u-3-4">
      <div>
          <header class="post-header">
    <h1 class="post-title">My bash prompt</h1>
    <div class="post-meta">Posted on 2013 Oct 29</div>
  </header>
  <p>If I&#39;m going to name this blog <code>prompt.sh</code>, I should probably mention what&#39;s in my own <code>bash</code> prompt at some point.</p>

<p>My prompt has expanded and contracted over the years. When developing more in Ruby and Python, I found it very important to keep my current language versions in the prompt, but these days it&#39;s more important to me that my prompt works on every Unix-based machine I might log on to.</p>

<p>I keep my prompt setup in a file called <a href="https://github.com/cndreisbach/dotfiles/blob/master/.bash/prompt.sh"><code>prompt.sh</code></a>, of course.</p>

<p>Here&#39;s what my prompt looks like after running a command for 10 seconds that resulted in an error:</p>

<p><img alt="prompt screenshot" src="/images/articles/prompt.png" /></p>

<p>On the first line, I have my current directory then my current Git branch, if I&#39;m in a Git repository. Note the asterisk beside the Git branch: that means that I have uncommitted changes. Next, I have the amount of time the previous command took. This only shows up if the amount of time it took was 5 or more seconds; below that, it&#39;s not that important to know. Lastly, I have the exit status of the last command. I only show this if the exit status is not zero; that is, if there was an error.</p>

<p>To get the Git branch and the change status, I have these two functions:</p>

<pre><code class="sh">function parse_git_dirty() {
  [[ $(git status 2&gt; /dev/null | tail -n1) != *&quot;nothing to commit&quot;* ]] &amp;&amp; echo &quot;*&quot;
}

function parse_git_branch() {
  local git_branch=$(git branch --no-color 2&gt; /dev/null | sed -e &#39;/^[^*]/d&#39; -e &quot;s/* \(.*\)/\1$(parse_git_dirty)/&quot;)
  [[ -z $git_branch ]] || echo &quot; $git_branch&quot;
}
</code></pre>

<p>This is all pretty simple stuff. To get the branch, I run <code>git branch</code> and then use <code>sed</code> to get the line that starts with <code>*</code> and strip the <code>*</code> out. I append an asterisk to that if I know the repo is dirty (that is, there are uncommitted changes.) What&#39;s interesting here is that I pipe <code>STDOUT</code> to <code>/dev/null</code> in both these cases, and count on failure -- which will only happen if I&#39;m not in a Git repo -- to produce no text. There is no test to see if I&#39;m in a repo: I just go ahead and try it and print nothing on error.</p>

<p>The timer code is way more interesting:</p>

<pre><code class="sh">function timer_start() {
  timer=${timer:-$SECONDS}
}

function timer_stop() {
  timer_show=$(($SECONDS - $timer))
  unset timer
}

function prompt_command() {
  # ...
  timer_stop
  #...
}

PROMPT_COMMAND=prompt_command

trap timer_start DEBUG
</code></pre>

<p><code>SECONDS</code> increases monotonically like you&#39;d expect: add 1 every second. <code>trap timer_start DEBUG</code> is a neat piece of code. <code>trap</code> means &quot;run the following function on the following signal,&quot; and the signal <code>DEBUG</code> is triggered every time a command is run. So, every time a command is run, <code>timer_start</code> is run. <code>timer_start</code> sets <code>timer</code> to <code>$SECONDS</code> if it&#39;s not currently set. The function assigned to <code>PROMPT_COMMAND</code>, which is called <code>prompt_command</code> in this case, is run every time the prompt is printed. Inside <code>prompt_command</code>, I execute <code>timer_stop</code>, which sets the variable <code>timer_show</code> equal to the timer subtracted from the current value of <code>SECONDS</code>. I can use <code>timer_show</code>, which has the calculated value of the amount of time it took to run the last command, when displaying the prompt.</p>

<p>The rest of what I do, printing error codes and setting colors, is all simple stuff that you can pick up from reading the file.</p>

<p>When I first set up my current prompt, I colored the <code>$</code> character on the second line of my prompt. It looked nice, but I found that the characters printed to set the color, normally invisible, sometimes caused the command at the prompt to shift to the right when scrolling up through history.</p>



        <div class="footer">
          <div class=
          "pure-menu pure-menu-horizontal pure-menu-open">
            <ul>
              <li>
                <a href="/about.html">About</a>
              </li>

              <li>
                <a href=
                "http://twitter.com/cndreisbach/">Twitter</a>
              </li>

              <li>
                <a href="http://github.com/cndreisbach/">GitHub</a>
              </li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>
  <script src="/javascripts/all.js" type="text/javascript"></script>
</body>
</html>
